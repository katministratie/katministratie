@page "/CreateSuperkat"

@using Superkatten.Katministratie.Application.Entities
@using Superkatten.Katministratie.Web.Services

@inject NavigationManager NavigationManager
@inject ISuperkattenListService _superkattenService
@inject MessageService _message
@inject NotificationService _notice

<PageTitle>Nieuwe superkat</PageTitle>

<Row Class="border mb-2">
    <Col Class="col-4">
        <Button Block="@true" Disabled="@ValidCatchLocation" OnClick="@OnOk">Ok</Button>
    </Col>
    <Col Class="col-4">
        <Button Block="@true" Disabled="@ValidCatchLocation" OnClick="@OnOkAndNew">Nieuwe kat</Button>
    </Col>
    <Col Class="col-4">
        <Button Block="@true" OnClick="@OnCancel">Terug</Button>
    </Col>
</Row>

<Divider />

<Row Class="mb-2">
    <Col Class="col-12">
        <Input Placeholder="Voer vanglokatie in"  Size="@InputSize.Large" @bind-Value="@parameters.CatchLocation" >
            <Prefix>
                <Icon Type="border-inner" />
            </Prefix>
        </Input>
    </Col>

    <Col Class="col-12">
        Nummer van het hok: 
        <AntDesign.InputNumber 
            Min="1"
            Max="50"
            Disabled="@ValidCatchLocation" 
            DefaultValue="1" 
            Size="@InputSize.Small" 
            @bind-Value="@parameters.CageNumber"/>    
    </Col>
</Row>

<Row Class="mb-3">
    <Col Class="col-12">
        Kat gaat retour:
        <Switch Disabled="@ValidCatchLocation" @bind-Checked="@parameters.Retour"></Switch>
    </Col>
</Row>

<Row Class="mb-3">
    <Col Class="col-12">
        Kitten:
        <Switch Disabled="@ValidCatchLocation" @bind-Checked="@parameters.IsKitten"></Switch>
    </Col>
</Row>

<Row Class="mb-3">
    <Col Class="col-12">
        Vangdatum: 
        <DatePicker Disabled="@ValidCatchLocation" 
            Bordered="@false" 
            TValue="DateTime?" 
            Picker="@DatePickerType.Date" 
            OnChange="OnChangeCatchDate" 
            DefaultValue="@InitialDateTimeNow" 
            Placeholder="@VangdatumText"/>
    </Col>
</Row>

<Row Class="mb-3">
    <Col Class="col-12">
        Geboortedatum:
        <DatePicker Disabled="@ValidCatchLocation" 
            Bordered="@false" 
            TValue="DateTime?" 
            Picker="@DatePickerType.Date" 
            OnChange="OnChangeBirthDate" 
            DefaultValue="@InitialDateTimeNow" 
            Placeholder="@GeboortedatumText"/>
    </Col>
</Row>

@code 
{
    private string VangdatumText { get; init; } = "Vangdatum";
    private string GeboortedatumText { get; init; } = "Geboortedatum";
    private DateTime InitialDateTimeNow => DateTime.UtcNow;
    private bool ValidCatchLocation => string.IsNullOrWhiteSpace(parameters.CatchLocation);

    private void OnChangeCatchDate(DateTimeChangedEventArgs args)
    {
        parameters.CatchDate = args.Date;
    }

    private void OnChangeBirthDate(DateTimeChangedEventArgs args)
    {
        parameters.CatchDate = args.Date;
    }


    private CreateSuperkatParameters parameters =
        new CreateSuperkatParameters()
            {
                CatchDate = DateTime.UtcNow,
                CatchLocation = string.Empty,
                Birthday = DateTime.UtcNow,
                Area = Domain.Entities.CatArea.Unknown,
                CageNumber = null,
                Behaviour = Domain.Entities.CatBehaviour.Unknown,
                Retour = false,
                IsKitten = false
            };

    public async Task OnOk()
    {
        await StoreSuperkat();
        NavigationManager.NavigateTo("/");
    }

    public async Task OnOkAndNew()
    {
        await StoreSuperkat();
        await _message.Warning("Voer de volgende superkat in", 2);
    }

    public void OnCancel()
    {
        NavigationManager.NavigateTo("/");
    }

    private async Task StoreSuperkat()
    {
        var superkat = await _superkattenService.CreateSuperkatAsync(parameters);
        if (superkat is null)
        {
            await _message.Error($"Fout bij het opslaan van de nieuwe superkat.", 3);            
        }

        await _message.Success($"Superkat is opgeslagen onder nummer {superkat.DisplayableNumber}", 3);        
    }
}
